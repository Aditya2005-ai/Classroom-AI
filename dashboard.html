<!DOCTYPE html>
<html lang="en" class="bg-[#0f172a] text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Classroom.AI ‚Äì Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .card {
      background-color: #1e293b;
      border: 1px solid #334155;
      transition: 0.3s;
    }

    .card:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col px-6 py-10">

  <!-- Top Header -->
  <header class="flex items-center gap-3 px-6 py-4 bg-[#0f172a] fixed top-0 left-0 w-full z-50">
    <img src="logo.png" alt="Logo" class="w-10 h-10 object-contain" />
    <h1 class="text-2xl font-bold text-blue-400">Classroom.AI</h1>
  </header>

  <div class="pt-20 px-6">
    <!-- User Profile Section -->
    <section class="flex items-start gap-6 mb-10">
      <div class="flex flex-col items-center">
        <img id="userAvatar" src="user.png" alt="Avatar" class="w-28 h-28 rounded-full object-cover border-2 border-blue-500" />
        <button onclick="openEditModal()" class="flex items-center text-xs text-blue-400 hover:text-white transition mt-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13l6.293-6.293a1 1 0 011.414 0l.586.586a1 1 0 010 1.414L11 15H9v-2z" />
          </svg>
          Edit
        </button>
      </div>
      <div>
        <h2 id="userName" class="text-3xl font-bold text-blue-400">User Name</h2>
        <p id="userEmail" class="text-gray-300 text-sm mt-1">userName@example.com</p>
        <p id="userJoinDate" class="text-gray-500 text-xs mt-2">üìÖ Joined: ABC(month) XX, 20XX</p>
      </div>
    </section>

    <!-- Saved Projects Header -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-white">Saved Projects</h2>
      <button onclick="openProjectModal()" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg font-semibold">
        + Create New Project
      </button>
    </div>

    <!-- Project Cards Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
  </div>
   <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-[#1e293b] text-white p-6 rounded-xl max-w-md w-full relative">
      <h2 class="text-xl font-bold mb-4">Are you sure you want to delete this folder permanently?</h2>
      <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-semibold">Delete</button>
      <button onclick="closeDeleteModal()" class="ml-4 text-gray-400 hover:text-white">Cancel</button>
    </div>
  </div>
   
  <!-- Rename Folder Modal -->
  <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-[#1e293b] text-white p-6 rounded-xl max-w-md w-full relative">
      <h2 class="text-xl font-bold mb-4">Rename Folder</h2>
      <input id="renameInput" type="text" class="w-full mb-3 px-3 py-2 bg-[#0f172a] border border-gray-600 rounded" />
      <textarea id="renameDesc" class="w-full mb-3 px-3 py-2 bg-[#0f172a] border border-gray-600 rounded"></textarea>
      <button onclick="saveRename()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold">Save Changes</button>
      <button onclick="closeRenameModal()" class="ml-4 text-gray-400 hover:text-white">Cancel</button>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-[#1e293b] text-white rounded-xl shadow-xl w-full max-w-md p-6 relative">
      <button onclick="closeProjectModal()" class="absolute top-3 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
      <h2 class="text-2xl font-bold text-blue-400 mb-4 text-center">Create New Project</h2>
      <form onsubmit="saveProject(event)" class="space-y-4">
        <input type="text" id="projectName" placeholder="Name of Folder" required
          class="w-full px-4 py-2 bg-[#0f172a] border border-gray-600 rounded-md focus:outline-none" />
        <select id="projectType"
          class="w-full px-4 py-2 bg-[#0f172a] border border-gray-600 rounded-md focus:outline-none">
          <option>Text-Based</option>
          <option>Visual</option>
          <option>Audio</option>
          <option>Code</option>
        </select>
        <textarea id="projectDesc" placeholder="Short Description (optional)"
          class="w-full px-4 py-2 bg-[#0f172a] border border-gray-600 rounded-md focus:outline-none resize-none"></textarea>
        <button type="submit"
          class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded-md font-semibold">Save Project</button>
      </form>
    </div>
  </div>

  <!-- Folder View -->
  <div id="folderView" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-[#1e293b] text-white w-full max-w-2xl rounded-xl p-6 relative">
      <button onclick="closeFolderView()" class="absolute top-3 right-4 text-xl text-gray-400 hover:text-white">&times;</button>
      <h2 id="folderTitle" class="text-2xl font-bold text-blue-400 mb-4">üìÅ Folder Name</h2>
      <ul id="folderFiles" class="space-y-2"></ul>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-[#1e293b] text-white rounded-xl w-full max-w-md p-6 relative flex flex-col items-center">
      <button onclick="closeEditModal()" class="absolute top-3 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
      <img id="editProfilePic" src="user.png" class="w-24 h-24 rounded-full border-2 border-blue-500 mb-4" />
      <input id="editName" type="text" placeholder="Enter Name"
        class="w-full px-4 py-2 mb-3 bg-[#0f172a] border border-gray-600 rounded-md focus:outline-none text-sm" />
      <input id="editPhoto" type="text" placeholder="Profile Photo URL"
        class="w-full px-4 py-2 mb-3 bg-[#0f172a] border border-gray-600 rounded-md focus:outline-none text-sm" />
      <input id="editEmail" type="email" disabled
        class="w-full px-4 py-2 mb-4 bg-[#0f172a] border border-gray-600 rounded-md text-gray-400 text-sm" />
      <button onclick="saveProfileChanges()"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-sm rounded-md font-semibold">
        Save Changes
      </button>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { app } from "./auth.js";

  const auth = getAuth(app);
  const db = getFirestore(app);

  import {
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Add this below your onAuthStateChanged block
window.saveProject = async function (e) {
  e.preventDefault();
  
  const name = document.getElementById("projectName").value.trim();
  const type = document.getElementById("projectType").value;
  const desc = document.getElementById("projectDesc").value.trim();

  const user = auth.currentUser;
  if (!user) return;

  try {
    await addDoc(collection(db, "projects"), {
      name,
      type,
      description: desc,
      uid: user.uid,
      createdAt: serverTimestamp()
    });

    closeProjectModal();
    setTimeout(() => location.reload(), 500); // reload to show new folder
  } catch (err) {
    console.error("Error creating folder:", err);
    alert("Failed to create folder.");
  }
};


  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "home.html";

    document.getElementById("userName").textContent = user.displayName || "User";
    document.getElementById("userEmail").textContent = user.email;
    document.getElementById("userAvatar").src = user.photoURL || "user.png";
    document.getElementById("userJoinDate").textContent =
      `üìÖ Joined: ${new Date(user.metadata.creationTime).toLocaleDateString("en-IN", { year:"numeric", month:"long", day:"numeric" })}`;

    // Load folders
    const pQ = query(collection(db, "projects"), where("uid", "==", user.uid));
    const pSnap = await getDocs(pQ);
    const grid = document.querySelector(".grid");
    pSnap.forEach(docSnap => {
      const data = docSnap.data();
      const folderId = docSnap.id;
      const card = document.createElement("div");
      card.className = "card rounded-lg p-4 cursor-pointer relative";
      card.onclick = () => openFolderById(folderId, data.name);
      card.innerHTML = `
        <h3 class="font-semibold text-lg mb-2">üìÅ ${data.name}</h3>
        <p class="text-gray-400 text-sm">${data.description||""}</p>
      `;
      grid.appendChild(card);
    });
  });

  window.openFolderById = async function(folderId, folderName) {
    document.getElementById('folderTitle').textContent = `üìÅ ${folderName}`;
    const fileList = document.getElementById('folderFiles');
    fileList.innerHTML = "";

    const fQ = query(collection(db, `projects/${folderId}/files`), where("uid","==", auth.currentUser.uid));
    const fSnap = await getDocs(fQ);
    if (fSnap.empty) {
      fileList.innerHTML = `<li class="text-gray-400">No files yet.</li>`;
    } else {
      fSnap.forEach(d=> {
        const f = d.data();
        const li = document.createElement("li");
        li.className = "bg-[#1e293b] border border-gray-700 px-4 py-2 rounded-md text-sm";
        li.innerHTML = `<strong>${f.title}</strong><br><span class="text-gray-400 text-xs">${f.content.slice(0,100)}‚Ä¶</span>`;
        fileList.appendChild(li);
      });
    }

    document.getElementById('folderView').classList.remove("hidden");
    document.getElementById('folderView').classList.add("flex");
  };
</script>

<script>
  function closeFolderView() {
    document.getElementById('folderView').classList.add("hidden");
    document.getElementById('folderView').classList.remove("flex");
  }
</script>

  <!-- Non-module Script -->
  <script>
   

    function closeEditModal() {
      document.getElementById("editModal").classList.add("hidden");
      document.getElementById("editModal").classList.remove("flex");
    }

    function openProjectModal() {
      document.getElementById("projectModal").classList.remove("hidden");
      document.getElementById("projectModal").classList.add("flex");
    }

    function closeProjectModal() {
      document.getElementById("projectModal").classList.add("hidden");
      document.getElementById("projectModal").classList.remove("flex");
    }

    function openFolder(name, desc) {
      document.getElementById('folderTitle').textContent = `üìÅ ${name}`;

      const fileList = document.getElementById('folderFiles');
      fileList.innerHTML = "";

      // When connected to Firestore, fetch and render files here
      // Example placeholder (optional):
      // const li = document.createElement('li');
      // li.textContent = "No files available yet.";
      // fileList.appendChild(li);

      document.getElementById('folderView').classList.remove("hidden");
      document.getElementById('folderView').classList.add("flex");
    }


    function closeFolderView() {
      document.getElementById('folderView').classList.add("hidden");
      document.getElementById('folderView').classList.remove("flex");
    }
  </script>
</body>
<script>
  let selectedFolderId = null;

window.confirmDelete = function (folderId) {
  selectedFolderId = folderId;
  document.getElementById("deleteModal").classList.remove("hidden");
  document.getElementById("deleteModal").classList.add("flex");
};

window.deleteFolder = async function () {
  const db = getFirestore(app);
  await deleteDoc(doc(db, "projects", selectedFolderId));
  setTimeout(() => location.reload(), 500);
};
  let renameFolderId = null;

window.openRenameModal = function (folderId, name, desc) {
  renameFolderId = folderId;
  document.getElementById("renameInput").value = name;
  document.getElementById("renameDesc").value = desc;
  document.getElementById("renameModal").classList.remove("hidden");
  document.getElementById("renameModal").classList.add("flex");
};

window.saveRename = async function () {
  const newName = document.getElementById("renameInput").value.trim();
  const newDesc = document.getElementById("renameDesc").value.trim();
  const db = getFirestore(app);
  await updateDoc(doc(db, "projects", renameFolderId), {
    name: newName,
    description: newDesc
  });
  setTimeout(() => location.reload(), 500);
};
async function openFolder(name, desc) {
  document.getElementById('folderTitle').textContent = `üìÅ ${name}`;
  const fileList = document.getElementById('folderFiles');
  fileList.innerHTML = "";

  try {
    const user = auth.currentUser;
    if (!user) return;

    // üîç Step 1: Find the folderId from name
    const q = query(collection(db, "projects"), where("uid", "==", user.uid), where("name", "==", name));
    const snap = await getDocs(q);

    if (!snap.empty) {
      const folderDoc = snap.docs[0];
      const folderId = folderDoc.id;

      // üîç Step 2: Get all files from this folder's subcollection
      const filesRef = collection(db, `projects/${folderId}/files`);
      const fileSnap = await getDocs(filesRef);

      if (fileSnap.empty) {
        fileList.innerHTML = `<li class="text-gray-400">No files found in this folder.</li>`;
      } else {
        fileSnap.forEach(doc => {
          const file = doc.data();
          const li = document.createElement("li");
          li.className = "bg-[#0f172a] border border-gray-700 px-4 py-2 rounded-md text-sm";
          li.innerHTML = `<strong>${file.title}</strong><br><span class="text-gray-400 text-xs">${file.content.slice(0, 100)}...</span>`;
          fileList.appendChild(li);
        });
      }
    }
  } catch (e) {
    console.error("Error fetching files:", e);
    fileList.innerHTML = `<li class="text-red-500 text-sm">Error loading files.</li>`;
  }

  // Show the folder modal
  document.getElementById('folderView').classList.remove("hidden");
  document.getElementById('folderView').classList.add("flex");
}

</script>
</html>
